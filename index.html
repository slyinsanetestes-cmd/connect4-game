<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 em Linha</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0f172a; 
            color: white; 
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .title { 
            font-size: 32px; 
            background: linear-gradient(45deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 15px 0;
        }
        .card {
            background: #1e293b;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #334155;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(45deg, #3b82f6, #10b981);
            font-size: 18px;
        }
        .room {
            padding: 15px;
            background: #334155;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .room:hover { background: #475569; }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #334155;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- ConteÃºdo carregado via JavaScript -->
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        console.log("âœ… Web App carregado");
        console.log("ğŸ‘¤ UsuÃ¡rio:", tg.initDataUnsafe?.user);
        
        // Estado do jogo
        const state = {
            screen: 'menu',
            user: tg.initDataUnsafe?.user || null,
            rooms: [
                {id: 'free', name: 'ğŸ†“ GRATUITA', bet: 0},
                {id: '1', name: 'ğŸ’° R$ 1,00', bet: 1},
                {id: '2', name: 'ğŸ’µ R$ 2,00', bet: 2},
                {id: '5', name: 'ğŸ’¸ R$ 5,00', bet: 5},
                {id: '10', name: 'ğŸ’ R$ 10,00', bet: 10}
            ]
        };
        
        // Renderiza a tela
        function render() {
            const app = document.getElementById('app');
            
            if (state.screen === 'menu') {
                app.innerHTML = `
                    <div class="header">
                        <h1 class="title">4 EM LINHA</h1>
                        <p>Conecte 4 peÃ§as e ganhe!</p>
                    </div>
                    
                    <div class="card">
                        <p style="text-align: center; color: #94a3b8;">Seu Saldo</p>
                        <h2 style="text-align: center; color: #10b981; margin: 10px 0;">R$ 100.00</h2>
                        <button class="btn" onclick="sendAction('balance')">
                            ğŸ”„ Atualizar Saldo
                        </button>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showRooms()">
                        ğŸ® JOGAR AGORA
                    </button>
                    
                    <button class="btn" onclick="sendAction('profile')">
                        ğŸ“Š Meu Perfil
                    </button>
                    
                    <button class="btn" onclick="sendAction('ranking')">
                        ğŸ† Ranking
                    </button>
                    
                    <button class="btn" onclick="sendAction('deposit')">
                        ğŸ’³ Depositar
                    </button>
                    
                    <button class="btn" onclick="sendAction('withdraw')">
                        ğŸ’¸ Sacar
                    </button>
                    
                    ${state.user ? `
                        <div style="text-align: center; margin-top: 20px; color: #94a3b8;">
                            ğŸ‘¤ ${state.user.first_name} | ID: ${state.user.id}
                        </div>
                    ` : ''}
                `;
            }
            else if (state.screen === 'rooms') {
                app.innerHTML = `
                    <button class="btn" onclick="goToMenu()" style="margin-bottom: 20px;">
                        â† Voltar
                    </button>
                    
                    <div class="card">
                        <h3 style="text-align: center;">Escolha uma Sala</h3>
                        
                        ${state.rooms.map(room => `
                            <div class="room" onclick="joinRoom('${room.id}')">
                                <div style="font-size: 18px; font-weight: bold;">${room.name}</div>
                                <div style="color: #94a3b8; margin-top: 5px;">
                                    Aposta: R$ ${room.bet.toFixed(2)} | PrÃªmio: R$ ${(room.bet * 1.8).toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            else if (state.screen === 'waiting') {
                app.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <h3>ğŸ” Buscando Oponente...</h3>
                        <p>Aguarde enquanto encontramos alguÃ©m para jogar com vocÃª</p>
                        <button class="btn" onclick="cancelSearch()" style="background: #ef4444; margin-top: 20px;">
                            âŒ Cancelar Busca
                        </button>
                    </div>
                `;
            }
        }
        
        // FunÃ§Ãµes de navegaÃ§Ã£o
        function showRooms() {
            state.screen = 'rooms';
            render();
        }
        
        function goToMenu() {
            state.screen = 'menu';
            render();
        }
        
        function joinRoom(roomId) {
            console.log("Entrando na sala:", roomId);
            
            // Envia para o bot
            sendAction('join_room', { room_id: roomId });
            
            // Muda para tela de espera
            state.screen = 'waiting';
            render();
            
            tg.showAlert(`Buscando oponente na sala ${roomId}...`);
            
            // Timeout apÃ³s 30 segundos
            setTimeout(() => {
                if (state.screen === 'waiting') {
                    state.screen = 'menu';
                    render();
                    tg.showAlert("NÃ£o encontramos oponentes. Tente novamente!");
                }
            }, 30000);
        }
        
        function cancelSearch() {
            sendAction('cancel_search');
            state.screen = 'menu';
            render();
            tg.showAlert("Busca cancelada!");
        }
        
        // ComunicaÃ§Ã£o com o bot
        function sendAction(action, data = {}) {
            console.log("Enviando:", action, data);
            
            const message = {
                action: action,
                user_id: state.user?.id,
                username: state.user?.first_name || "Jogador",
                timestamp: Date.now(),
                ...data
            };
            
            try {
                tg.sendData(JSON.stringify(message));
                console.log("âœ… Dados enviados ao bot");
            } catch (error) {
                console.error("âŒ Erro:", error);
                tg.showAlert("Erro ao enviar. Tente novamente.");
            }
        }
        
        // Inicializa
        render();
        tg.showAlert("Bem-vindo ao 4 em Linha! ğŸ®");
        
        // Event listeners
        tg.onEvent('viewportChanged', () => {
            console.log("Tamanho da tela alterado");
        });
    </script>
</body>
</html>
