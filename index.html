<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 em Linha</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0f172a; 
            color: white; 
            font-family: Arial, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto;
            padding-bottom: 20px;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .title { 
            font-size: 32px; 
            background: linear-gradient(45deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 15px 0;
        }
        .card {
            background: #1e293b;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #334155;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #3b82f6, #10b981);
            font-size: 18px;
        }
        .room {
            padding: 15px;
            background: #334155;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .room:hover { 
            background: #475569;
            transform: translateX(5px);
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #334155;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app">
            <!-- Conte√∫do carregado aqui -->
        </div>
        
        <div class="debug" id="debug">
            <!-- Logs de debug -->
        </div>
    </div>

    <script>
        // ============ INICIALIZA√á√ÉO ============
        const tg = window.Telegram.WebApp;
        
        // Expandir e inicializar
        tg.expand();
        tg.ready();
        
        console.log("=== WEB APP INICIADO ===");
        console.log("Plataforma:", tg.platform);
        console.log("Vers√£o:", tg.version);
        console.log("User:", tg.initDataUnsafe?.user);
        
        // Fun√ß√£o para logs visuais
        function logDebug(msg) {
            console.log(msg);
            const debugDiv = document.getElementById('debug');
            if (debugDiv) {
                debugDiv.innerHTML += msg + '<br>';
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
        
        logDebug("‚úÖ Web App carregado");
        logDebug(`üë§ Usu√°rio: ${tg.initDataUnsafe?.user?.first_name || 'An√¥nimo'}`);
        
        // ============ ESTADO ============
        const state = {
            screen: 'menu',
            user: tg.initDataUnsafe?.user || null,
            rooms: [
                {id: 'free', name: 'üÜì GRATUITA', bet: 0, color: '#94a3b8'},
                {id: '1', name: 'üí∞ R$ 1,00', bet: 1, color: '#10b981'},
                {id: '2', name: 'üíµ R$ 2,00', bet: 2, color: '#fbbf24'},
                {id: '5', name: 'üí∏ R$ 5,00', bet: 5, color: '#f97316'},
                {id: '10', name: 'üíé R$ 10,00', bet: 10, color: '#8b5cf6'}
            ],
            searching: false
        };
        
        // ============ RENDERIZA√á√ÉO ============
        function render() {
            const app = document.getElementById('app');
            
            if (state.screen === 'menu') {
                app.innerHTML = `
                    <div class="header">
                        <div style="font-size: 48px; margin-bottom: 10px;">üéÆ</div>
                        <h1 class="title">4 EM LINHA</h1>
                        <p>Conecte 4 pe√ßas e ganhe!</p>
                    </div>
                    
                    <div class="card">
                        <p style="text-align: center; color: #94a3b8;">Seu Saldo</p>
                        <h2 style="text-align: center; color: #10b981; margin: 10px 0;">R$ 100.00</h2>
                        <button class="btn" onclick="sendAction('balance')">
                            üîÑ Atualizar Saldo
                        </button>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showRooms()">
                        üéÆ JOGAR AGORA
                    </button>
                    
                    <button class="btn" onclick="sendAction('profile')">
                        üìä Meu Perfil
                    </button>
                    
                    <button class="btn" onclick="sendAction('ranking')">
                        üèÜ Ranking
                    </button>
                    
                    <button class="btn" onclick="sendAction('deposit')">
                        üí≥ Depositar
                    </button>
                    
                    <button class="btn" onclick="sendAction('withdraw')">
                        üí∏ Sacar
                    </button>
                    
                    ${state.user ? `
                        <div style="text-align: center; margin-top: 20px; color: #94a3b8; padding: 10px; background: #1e293b; border-radius: 10px;">
                            üë§ <strong>${state.user.first_name}</strong><br>
                            üÜî ID: ${state.user.id}
                        </div>
                    ` : ''}
                `;
            }
            else if (state.screen === 'rooms') {
                app.innerHTML = `
                    <button class="btn" onclick="goToMenu()" style="margin-bottom: 20px;">
                        ‚Üê Voltar ao Menu
                    </button>
                    
                    <div class="card">
                        <h3 style="text-align: center; margin-bottom: 20px;">üéØ Escolha uma Sala</h3>
                        
                        ${state.rooms.map(room => `
                            <div class="room" onclick="joinRoom('${room.id}')" 
                                 style="border-left: 5px solid ${room.color};">
                                <div style="font-size: 18px; font-weight: bold;">${room.name}</div>
                                <div style="color: #94a3b8; margin-top: 5px; font-size: 14px;">
                                    üíµ Aposta: R$ ${room.bet.toFixed(2)}<br>
                                    üèÜ Pr√™mio: R$ ${(room.bet * 1.8).toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                        
                        <div style="text-align: center; margin-top: 20px; color: #94a3b8; font-size: 14px;">
                            üí° Dica: Comece pela sala gratuita!
                        </div>
                    </div>
                `;
            }
            else if (state.screen === 'waiting') {
                app.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <h3>üîç Buscando Oponente...</h3>
                        <p style="color: #94a3b8; margin: 10px 0;">
                            Aguarde enquanto encontramos algu√©m para jogar com voc√™.
                            Isso pode levar alguns segundos.
                        </p>
                        
                        <div style="background: #1e293b; padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <div style="color: #fbbf24;">‚è∞ Tempo estimado: 10-30 segundos</div>
                            <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">
                                Se demorar muito, tente outra sala
                            </div>
                        </div>
                        
                        <button class="btn" onclick="cancelSearch()" 
                                style="background: linear-gradient(45deg, #ef4444, #dc2626);">
                            ‚ùå Cancelar Busca
                        </button>
                    </div>
                `;
            }
        }
        
        // ============ FUN√á√ïES ============
        function showRooms() {
            logDebug("Mostrando salas...");
            state.screen = 'rooms';
            render();
        }
        
        function goToMenu() {
            logDebug("Voltando ao menu...");
            state.screen = 'menu';
            render();
        }
        
        function joinRoom(roomId) {
            logDebug(`Tentando entrar na sala: ${roomId}`);
            
            // Envia para o bot
            sendAction('join_room', { room_id: roomId });
            
            // Muda para tela de espera
            state.screen = 'waiting';
            state.searching = true;
            render();
            
            // Timeout ap√≥s 30 segundos
            setTimeout(() => {
                if (state.searching) {
                    logDebug("‚è∞ Timeout - Nenhum oponente encontrado");
                    state.searching = false;
                    state.screen = 'menu';
                    render();
                    tg.showAlert("‚è∞ N√£o encontramos oponentes. Tente novamente!");
                }
            }, 30000);
        }
        
        function cancelSearch() {
            logDebug("Cancelando busca...");
            sendAction('cancel_search');
            state.searching = false;
            state.screen = 'menu';
            render();
            tg.showAlert("‚úÖ Busca cancelada!");
        }
        
        // ============ COMUNICA√á√ÉO COM BOT ============
        function sendAction(action, data = {}) {
            const message = {
                action: action,
                user_id: state.user?.id,
                username: state.user?.first_name || "Jogador",
                timestamp: Date.now(),
                ...data
            };
            
            logDebug(`üì§ Enviando: ${action} ${JSON.stringify(data)}`);
            
            try {
                // DEBUG: Mostra o que est√° sendo enviado
                console.log("Mensagem para o bot:", message);
                
                // Envia para o bot
                tg.sendData(JSON.stringify(message));
                logDebug("‚úÖ Dados enviados com sucesso!");
                
                // Feedback visual
                tg.showAlert(`Enviado: ${action}`);
                
            } catch (error) {
                logDebug(`‚ùå Erro ao enviar: ${error}`);
                tg.showAlert("‚ùå Erro ao enviar dados. Tente novamente.");
            }
        }
        
        // ============ EVENTOS ============
        tg.onEvent('themeChanged', () => {
            logDebug("üé® Tema alterado");
        });
        
        tg.onEvent('viewportChanged', (e) => {
            logDebug(`üì± Viewport: ${e.width}x${e.height}`);
        });
        
        // ============ INICIALIZA√á√ÉO ============
        logDebug("üé¨ Inicializando interface...");
        render();
        
        // Mostra mensagem de boas-vindas
        setTimeout(() => {
            tg.showAlert("üéÆ Bem-vindo ao 4 em Linha!\nClique em JOGAR AGORA para come√ßar!");
        }, 500);
        
        // Log adicional
        logDebug("‚úÖ Interface carregada com sucesso!");
    </script>
</body>
</html>
